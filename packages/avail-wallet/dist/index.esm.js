import e,{createContext as t,useState as a,useEffect as l,useContext as n,memo as r,useCallback as s}from"react";import{getWalletBySource as o,getWallets as c}from"@talismn/connect-wallets";import{initialize as i,disconnect as d}from"avail-js-sdk";import{create as w}from"zustand";import{persist as m,createJSONStorage as u}from"zustand/middleware";async function p(e=window.ethereum){try{return await e.request({method:"wallet_getSnaps"}),!0}catch(e){return!1}}process.env.SNAP_ORIGIN;const h=t({provider:null,installedSnap:null,error:null,setInstalledSnap:()=>{},setError:()=>{}}),v=({children:t})=>{const[n,r]=a(null),[s,o]=a(null),[c,i]=a(null);return l((()=>{(async function(){var e,t;if("undefined"==typeof window)return null;if(window.ethereum&&await p(window.ethereum))return window.ethereum;if(null===(e=window.ethereum)||void 0===e?void 0:e.detected)for(const e of window.ethereum.detected)if(await p(e))return e;if(null===(t=window.ethereum)||void 0===t?void 0:t.providers)for(const e of window.ethereum.providers)if(await p(e))return e;return null})().then(r).catch(console.error)}),[]),l((()=>{if(c){const e=setTimeout((()=>{i(null)}),1e4);return()=>{clearTimeout(e)}}}),[c]),e.createElement(h.Provider,{value:{provider:n,error:c,setError:i,installedSnap:s,setInstalledSnap:o}},t)};function f(){return n(h)}var g;const y=null!==(g=process.env.SNAP_ORIGIN)&&void 0!==g?g:"npm:@avail-project/avail-snap";function x(){const e=f();return async({method:t,params:a})=>{var l,n;try{return null!==(n=await(null===(l=e.provider)||void 0===l?void 0:l.request({method:t,params:a})))&&void 0!==n?n:null}catch(t){return e.setError(t),null}}}function E(){const{provider:e,setInstalledSnap:t,installedSnap:n}=f(),r=x(),[s,o]=a(!1),[c,i]=a(!1);l((()=>{(()=>{if("undefined"==typeof window)return;const{ethereum:e}=window,t=Boolean(e&&e.isMetaMask);i(t)})()}),[]);const d=null!==e,w=()=>{const{ethereum:e}=window;return Boolean(e&&e.isMetaMask)},m=async()=>{var e;const a=await r({method:"wallet_getSnaps"});t(null!==(e=a[y])&&void 0!==e?e:null)};return l((()=>{(async()=>{e&&(await w(),await m())})().catch(console.error)}),[e]),{isFlask:s,snapsDetected:d,installedSnap:n,getSnap:m,detectMetaMask:w,metamaskInstalled:c}}function k(e=y){const t=x();return async({method:a,params:l})=>t({method:"wallet_invokeSnap",params:{snapId:e,request:l?{method:a,params:l}:{method:a}}})}function b(e=y,t){const a=x(),{setInstalledSnap:l}=f();return async()=>{var n;const r=await a({method:"wallet_requestSnaps",params:{[e]:t?{version:t}:{}}});l(null!==(n=null==r?void 0:r[e])&&void 0!==n?n:null)}}const S=r((({selected:t,installedSnap:a,onDisconnect:l})=>{var n,r;return t?e.createElement("div",{className:"aw-flex-row aw-items-center aw-justify-center aw-text-sm aw-font-medium aw-rounded-xl aw-cursor-pointer aw-bg-darker aw-text-white aw-p-4",onClick:()=>{navigator.clipboard.writeText(t.address)}},e.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"aw-pr-2 aw-h-5 aw-w-5"},e.createElement("path",{d:"M21 12V7H5a2 2 0 0 1 0-4h14v4"}),e.createElement("path",{d:"M3 5v14a2 2 0 0 0 2 2h16v-5"}),e.createElement("path",{d:"M18 9a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h4v-8Z"})),"MetamaskSnap"===t.source?a?t.address.slice(0,6)+"..."+(null===(n=t.address)||void 0===n?void 0:n.slice(-4)):"Retry Connecting":t.address.slice(0,6)+"..."+(null===(r=t.address)||void 0===r?void 0:r.slice(-4)),e.createElement("button",{className:"aw-ml-2 aw-button",onClick:l},"MetamaskSnap"===t.source?a?e.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 352 512",fill:"currentColor",width:"12",height:"12"},e.createElement("path",{d:"M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z"})):e.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512",fill:"currentColor",width:"12",height:"12"},e.createElement("path",{d:"M370.72 133.28C339.458 104.008 298.888 87.962 255.848 88c-77.458.068-144.328 53.178-162.791 126.85-1.344 5.363-6.122 9.15-11.651 9.15H24.103c-7.498 0-13.194-6.807-11.807-14.176C33.933 94.924 134.813 8 256 8c66.448 0 126.791 26.136 171.315 68.685L463.03 40.97C478.149 25.851 504 36.559 504 57.941V192c0 13.255-10.745 24-24 24H345.941c-21.382 0-32.09-25.851-16.971-40.971l41.75-41.749zM32 296h134.059c21.382 0 32.09 25.851 16.971 40.971l-41.75 41.75c31.262 29.273 71.835 45.319 114.876 45.28 77.418-.07 144.315-53.144 162.787-126.849 1.344-5.363 6.122-9.15 11.651-9.15h57.304c7.498 0 13.194 6.807 11.807 14.176C478.067 417.076 377.187 504 256 504c-66.448 0-126.791-26.136-171.315-68.685L48.97 471.03C33.851 486.149 8 475.441 8 454.059V320c0-13.255 10.745-24 24-24z"})):e.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 352 512",fill:"currentColor",width:"12",height:"12"},e.createElement("path",{d:"M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z"})))):null}));S.displayName="DisconnectWallet";const N=r((({selectedWallet:t,enabledAccounts:a,onAccountSelect:l})=>e.createElement(e.Fragment,null,e.createElement("br",null),t&&e.createElement("button",{className:"aw-text-lg aw-mt-3 aw-w-full aw-font-thin aw-bg-darker aw-text-left aw-rounded-xl aw-p-8"},e.createElement("div",{className:"aw-flex-row"},e.createElement("img",{alt:t.title,height:20,width:20,src:t.logo.src,className:"aw-mr-4"}),t.title)),e.createElement("p",{className:"aw-text-white aw-my-3 aw-mt-4 aw-text-opacity-70 aw-font-light aw-text-sm aw-flex-row aw-items-center aw-justify-center aw-space-x-2"},e.createElement("span",null,"Select Accounts"),e.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"aw-h-4 aw-w-4"},e.createElement("circle",{cx:"12",cy:"12",r:"10"}),e.createElement("polyline",{points:"8 12 12 16 16 12"}),e.createElement("line",{x1:"12",y1:"8",x2:"12",y2:"16"}))),e.createElement("div",{className:"aw-flex-col aw-gap-2 aw-max-h-48 aw-overflow-y-scroll aw-overflow-x-hidden aw-pt-2"},a.map(((t,a)=>{var n,r;return e.createElement("button",{key:a,onClick:()=>l(t),className:"aw-flex-row aw-items-center aw-justify-between aw-bg-darker aw-rounded-xl aw-h-14 aw-p-4 aw-button"},e.createElement("div",{className:"aw-flex-row aw-items-center aw-justify-start aw-mx-auto aw-w-full"},e.createElement("div",{className:"aw-text-white aw-text-opacity-90 aw-space-x-2 aw-text-md aw-flex-row aw-items-center aw-justify-start"},e.createElement("p",null,"> "),e.createElement("p",{className:"aw-font-semibold aw-text-xl aw-cursor-pointer"},(null===(n=t.name)||void 0===n?void 0:n.length)>12?(null===(r=t.name)||void 0===r?void 0:r.slice(0,12))+"...":t.name),e.createElement("p",{className:"aw-text-blue"}," ","(",t.address.slice(0,6)+"..."+t.address.slice(-4),")"))))}))))));N.displayName="AccountSelector";const C=e=>({chain:e.runtimeChain.toString(),specVersion:e.runtimeVersion.specVersion.toNumber(),tokenDecimals:e.registry.chainDecimals[0]||18,tokenSymbol:e.registry.chainTokens[0]||"AVAIL",genesisHash:e.genesisHash.toHex(),ss58Format:"number"==typeof e.registry.chainSS58?e.registry.chainSS58:0,chainType:"substrate",icon:"substrate",types:{},userExtensions:[]});async function W({api:e,account:t,metadataCookie:a,selectedWallet:l,setCookie:n}){const r=o(t.source);if(e&&e.isConnected&&await e.isReady){if(r&&(!a||!a||a.wallet!==l.title))try{const t=C(e);await r.extension.metadata.provide(t),n("metadataUpdated",{wallet:l.title,updated:!0},{})}catch(e){console.error("Failed to update metadata",e)}}else console.debug("API not ready, cannot update metadata")}const A=async(e,t=3)=>{try{console.log(`Initializing API. Retries left: ${t}`);return await i(e)}catch(a){if(d(),t>0)return await new Promise((e=>setTimeout(e,2e3))),console.debug(`Retrying to initialize API. Retries left: ${t}`),A(e,t-1);throw new Error(`RPC_INITIALIZE_ERROR: ${a}`)}},I=r((({supportedWallets:t,onWalletSelect:a,metamaskInstalled:l})=>{const n=e.useMemo((()=>t.sort(((e,t)=>"SubWallet"===e.title?-1:"SubWallet"===t.title?1:0))),[t]);return e.createElement("div",{className:"aw-flex-col aw-gap-3 aw-max-h-72 aw-overflow-y-scroll"},e.createElement("button",{disabled:!l,className:"aw-text-lg aw-font-thin aw-bg-darker aw-text-left aw-rounded-xl aw-p-8 aw-button",onClick:()=>a({title:"MetamaskSnap"}),key:"Metamask"},e.createElement("div",{className:"aw-flex-row"},e.createElement("img",{alt:"Metamask Snap",src:"/images/availsnap.png",width:"24",height:"24",className:"aw-mr-4 aw-h-6 aw-w-6"}),"Avail Snap")),n.map((t=>e.createElement("button",{key:t.title,disabled:!t.installed,className:"aw-text-lg aw-font-thin aw-bg-darker aw-text-left aw-rounded-xl aw-p-8 aw-button",onClick:()=>a(t)},e.createElement("div",{className:"aw-flex-row"},e.createElement("img",{alt:t.title,height:"20",width:"20",src:t.logo.src,className:"aw-mr-4"}),t.title)))))}));I.displayName="WalletSelector";const M=w()(m((e=>({selected:null,setSelected:t=>e({selected:t}),selectedWallet:null,setSelectedWallet:t=>e({selectedWallet:t}),metadataUpdated:!1,setMetadataUpdated:t=>e({metadataUpdated:t}),clearWalletState:()=>e({selected:null,selectedWallet:null,metadataUpdated:!1})})),{name:"avail-wallet-storage",storage:u((()=>localStorage)),partialize:e=>({selected:e.selected,selectedWallet:e.selectedWallet,metadataUpdated:e.metadataUpdated})})),L=w(((e,t)=>({api:void 0,isReady:!1,setApi:t=>e({api:t}),ensureConnection:async a=>{const l=t().api;if((null==l?void 0:l.isConnected)&&await l.isReady)e({isReady:!0});else try{const l=await a();return l.on("ready",(()=>{e({isReady:!0})})),l.on("disconnected",(async()=>{e({isReady:!1}),setTimeout((()=>t().ensureConnection(a)),5e3)})),void e({api:l,isReady:!0})}catch(l){console.error("API_INTIALIZATION_ERROR",l),e({isReady:!1}),setTimeout((()=>t().ensureConnection(a)),5e3)}}}))),R=({api:t})=>{const[n,r]=a(!1),[o,i]=a([]),[d,w]=a([]),{api:m}=L(),u=b(),p=k(),{selected:h,setSelected:v,selectedWallet:f,setSelectedWallet:g,metadataUpdated:y,setMetadataUpdated:x,clearWalletState:C}=M(),{installedSnap:A,metamaskInstalled:R}=E(),_=s((()=>{const e=c();return i(e),e}),[]);l((()=>{(async()=>{const e=_();if((null==h?void 0:h.address)&&(null==f?void 0:f.title))if("MetamaskSnap"===f.title&&A);else{const t=e.find((e=>e.title===(null==f?void 0:f.title)));if(!t)return;t.enable("bridge-ui").then((()=>{t.getAccounts().then((e=>{const t=e.filter((e=>"ethereum"!==e.type));t.find((e=>e.address===(null==h?void 0:h.address)))&&w(t)}))}))}})()}),[A,R,_]);const U=s((async e=>{if("MetamaskSnap"===e.title)try{await u();const e=await p({method:"getAddress"});v({address:e,source:"MetamaskSnap"}),g({title:"MetamaskSnap"})}catch(e){console.error("Failed to connect to Avail Snap",e)}else{g(e),await e.enable("avail-wallet");const t=(await e.getAccounts()).filter((e=>"ethereum"!==e.type));w(t)}}),[p,u,v,g]),j=s((async e=>{v(e);const a=t||m;a&&f&&await W({api:a,account:e,metadataCookie:y,selectedWallet:f,setCookie:(e,t,a)=>{"metadataUpdated"===e&&x(t)}}),r(!1),console.info(`AVAIL_WALLET_CONNECT - ${null==f?void 0:f.title} - ${e.address}`)}),[f,t,m,y,x,v]),T=s((()=>{C(),w([])}),[C]);return e.createElement(e.Fragment,null,h?e.createElement(S,{selected:h,installedSnap:A,onDisconnect:T}):e.createElement("div",null,e.createElement("button",{onClick:()=>r(!n),className:"aw-button aw-button-primary aw-ml-2"},"Connect Wallet"),n&&e.createElement("div",{className:"aw-dialog-overlay"},e.createElement("div",{className:"fixed inset-0 bg-black/50",onClick:()=>r(!1)}),e.createElement("div",{className:"aw-dialog-content"},e.createElement("div",{className:"aw-bg-dark aw-border-2 aw-border-darker aw-rounded-xl p-4"},e.createElement("div",null,e.createElement("h2",{className:"aw-font-bold aw-text-3xl aw-text-white"},"Connect Wallet"),0===d.length?e.createElement(e.Fragment,null,e.createElement("p",{className:"aw-text-md aw-text-white aw-text-opacity-70 aw-pt-2"},e.createElement("div",{className:"aw-flex-row aw-items-start aw-justify-start aw-pt-3 aw-space-x-2"},e.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},e.createElement("circle",{cx:"12",cy:"12",r:"10"}),e.createElement("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),e.createElement("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})),e.createElement("span",null,"Don't have an Avail Wallet yet? Checkout this"," ",e.createElement("a",{href:"https://docs.availspace.app/avail-space/web-dashboard-user-guide/getting-started/how-to-install-subwallet-and-create-a-new-avail-account?utm_source=avail&utm_medium=docspace&utm_campaign=avlclaim",className:"aw-underline",target:"_blank",rel:"noopener noreferrer"},"cool tutorial")," ","by Subwallet."))),e.createElement("div",{className:"pb-3"}),e.createElement(I,{supportedWallets:o,onWalletSelect:U,metamaskInstalled:R})):e.createElement(N,{selectedWallet:f,enabledAccounts:d,onAccountSelect:j})),e.createElement("div",{className:"flex w-full mt-2 text-white text-opacity-70 !flex-col !items-center !justify-center"},e.createElement("div",null,d&&d.length>0?e.createElement("button",{disabled:d.length<=0,className:"aw-bg-dark aw-button aw-button-outline",onClick:()=>{w([]),v(null)}},e.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"aw-h-7 aw-w-7 aw-pr-2 inline-block"},e.createElement("path",{d:"m12 19-7-7 7-7"}),e.createElement("path",{d:"M19 12H5"})),e.createElement("span",{className:"aw-text-lg"},"Go back to wallets")):e.createElement("p",null,"Scroll to find more wallets"))))))))},_=t({isConnected:!1,setRpcUrl:()=>{}}),U=()=>n(_),j=({children:t,api:n,rpcUrl:r})=>{const[s,o]=a(r||"wss://turing-rpc.avail.so/"),{selected:i,setSelected:d,selectedWallet:w,setSelectedWallet:m,metadataUpdated:u}=M(),{api:p,isReady:h,setApi:f,ensureConnection:g}=L();return l((()=>{if(n)return void f(n);if(!s)return;(async()=>{await g((()=>A(s)))})()}),[s,n,f,g]),l((()=>{(async()=>{if((null==i?void 0:i.address)&&(null==w?void 0:w.title)&&h&&"MetamaskSnap"!==w.title){const e=c().find((e=>e.title===w.title));if(!e)return;try{await e.enable("avail-wallet");const t=await e.getAccounts(),a=t.filter((e=>"ethereum"!==e.type)).find((e=>e.address===i.address));a&&(m(e),d(a))}catch(e){console.error("Failed to reconnect wallet:",e)}}})()}),[i,w,h,d,m]),e.createElement(v,null,e.createElement(_.Provider,{value:{api:p,isConnected:h,rpcUrl:s,setRpcUrl:o}},t))};export{N as AccountSelector,R as AvailWalletConnect,j as AvailWalletProvider,S as DisconnectWallet,h as MetaMaskContext,v as MetaMaskProvider,I as WalletSelector,C as getInjectorMetadata,A as initApi,W as updateMetadata,L as useApi,M as useAvailAccount,U as useAvailWallet,k as useInvokeSnap,E as useMetaMask,f as useMetaMaskContext,b as useRequestSnap};
//# sourceMappingURL=index.esm.js.map
